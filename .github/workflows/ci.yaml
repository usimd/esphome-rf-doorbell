name: Test and build
on:
  push:
  pull_request:

env:
  XC8_VERSION: "3.10"
  PROFILE: "default"
  PACK_FOLDER: "/opt/microchip/packs"

jobs:
  build-esphome-firmware:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install esphome
          export DOORBELL_API_ENCRYPTION_KEY=$(openssl rand 32 | base64 -)
          export DOORBELL_OTA_PASSWORD=$(uuidgen)
          envsubst < .github/workflows/secrets-ci.yaml > esphome/secrets.yaml

      - name: Patch ESPHome config to use local instead of git for custom components
        run: |
          sed -i 's|type: git|type: local|g' esphome/doorbell.yaml
          sed -Ei 's|url: [^\n]+|path: components|g' esphome/doorbell.yaml
          sed -i '/ref: main/d' esphome/doorbell.yaml

      - name: Run ESPHome build
        working-directory: esphome
        run: |
          esphome compile doorbell.yaml

      - name: Upload ESPHome firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: esphome-firmware
          path: |
            esphome/.esphome/build/esphome-rf-doorbell/.pioenvs/esphome-rf-doorbell/firmware.factory.bin
            esphome/.esphome/build/esphome-rf-doorbell/.pioenvs/esphome-rf-doorbell/firmware.ota.bin

      - name: Upload ESPHome external components
        uses: actions/upload-artifact@v4
        with:
          name: esphome-components
          path: esphome/components/

  build-remote-firmware:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: usimd/setup-xc-action@v1
        with:
          compiler: xc8
          version: ${{env.XC8_VERSION}}  

      - name: Run build
        working-directory: remote/firmware
        run: |
          # Download profile packs to folder
          sudo mkdir -p /${{ env.PACK_FOLDER }}
          sudo chown $USER /${{ env.PACK_FOLDER }}
          jq -r '.configurations[] | select(.name=="${{ env.PROFILE }}") | .packs[] | ("https://packs.download.microchip.com/" + .vendor + "." + .name + "." + .version + ".atpack" + "\n" + .vendor + "/" + .name + "/" + .version)' .vscode/remote.mplab.json | xargs -n2 sh -c 'curl --create-dirs -LO --output-dir /${{ env.PACK_FOLDER }}/$1 $0 && unzip -qq /${{ env.PACK_FOLDER }}/$1/* -d /${{ env.PACK_FOLDER }}/$1'
          
          cmake -G Ninja -S cmake/remote/${{ env.PROFILE }} --preset remote_default_conf --fresh -DPACK_REPO_PATH=${{ env.PACK_FOLDER }}
          cmake --build _build/remote/default -v --parallel

      - name: Upload remote firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: remote-firmware
          path: |
            remote/firmware/out/remote/default.*

  kicad-base-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: sparkengineering/kicad-action@v4
        with:
          kicad_sch: base/esphome-rf-doorbell.kicad_sch
          sch_pdf: true
          sch_bom: true
          sch_erc: true
          pcb_drc: true
          kicad_pcb: base/esphome-rf-doorbell.kicad_pcb
          pcb_gerbers: true  

      - name: Upload base PCB artifacts
        uses: actions/upload-artifact@v4
        with:
          name: base-pcb
          path: |
            base/esphome-rf-doorbell.pdf
            base/esphome-rf-doorbell-bom.csv
            base/esphome-rf-doorbell-gerbers/

      - name: Upload base ERC/DRC reports on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: base-pcb-reports
          path: |
            base/*.rpt

  kicad-remote-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: sparkengineering/kicad-action@v4
        with:
          kicad_sch: remote/remote.kicad_sch
          sch_pdf: true
          sch_bom: true
          sch_erc: true
          pcb_drc: true
          kicad_pcb: remote/remote.kicad_pcb
          pcb_gerbers: true  

      - name: Upload remote PCB artifacts
        uses: actions/upload-artifact@v4
        with:
          name: remote-pcb
          path: |
            remote/remote.pdf
            remote/remote-bom.csv
            remote/remote-gerbers/

      - name: Upload remote ERC/DRC reports on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: remote-pcb-reports
          path: |
            remote/*.rpt

  # Final job to consolidate all artifacts - only runs if all jobs succeed
  upload-release-artifacts:
    runs-on: ubuntu-latest
    needs:
      - build-esphome-firmware
      - build-remote-firmware
      - kicad-base-test
      - kicad-remote-test
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifact structure
        run: ls -laR artifacts/

      - name: Upload consolidated release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: esphome-rf-doorbell-release
          path: artifacts/
